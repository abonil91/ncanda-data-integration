#!/usr/bin/env python

##
##  Copyright 2012, 2013 SRI International
##
##  http://nitrc.org/projects/ncanda-datacore/
##
##  This file is part of the N-CANDA Data Component Software Suite, developed
##  and distributed by the Data Integration Component of the National
##  Consortium on Alcohol and NeuroDevelopment in Adolescence, supported by
##  the U.S. National Institute on Alcohol Abuse and Alcoholism (NIAAA) under
##  Grant No. 1U01 AA021697
##
##  The N-CANDA Data Component Software Suite is free software: you can
##  redistribute it and/or modify it under the terms of the GNU General Public
##  License as published by the Free Software Foundation, either version 3 of
##  the License, or (at your option) any later version.
##
##  The N-CANDA Data Component Software Suite is distributed in the hope that it
##  will be useful, but WITHOUT ANY WARRANTY; without even the implied
##  warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
##  GNU General Public License for more details.
##
##  You should have received a copy of the GNU General Public License along
##  with the N-CANDA Data Component Software Suite.  If not, see
##  <http://www.gnu.org/licenses/>.
##
##  $Revision$
##
##  $LastChangedDate$
##
##  $LastChangedBy$
##

import os
import argparse
import re
import sys

import pandas

import redcap

# Setup command line parser
parser = argparse.ArgumentParser( description="Upload e-Prime Stroop log file to file upload file in REDCap data entry form" )
parser.add_argument( "-v", "--verbose", help="Verbose operation", action="store_true")
parser.add_argument( "--api-key-file", help="File containing API Key for REDCap project", default=os.path.join( os.path.expanduser("~"), '.server_config/redcap-laptopimport-token' ) )
parser.add_argument( "--api-key", help="API Key for REDCap project", default=None )
parser.add_argument( "--record", help="Record ID (if not provided, this is generated from the information in the data file)", default=None )
parser.add_argument( "--event", help="Event in a longitudinal REDCap project (if not provided, a non-longitudinal project is assumed)", default=None )
parser.add_argument( "infile", help="Input .txt Stroop file (as generated by e-Prime).")
parser.add_argument( "tofield", help="Field to upload to")
args = parser.parse_args()

file = open( args.infile, 'r').read().decode('utf-16').split("\r\n")
    
date_of_test = None
subject = None
session = None

# Read ePrime log file and parse out subject, session, and date of test.
for s in file:
    if 'SessionDate:' in s:
        date_of_test = '%s-%s-%s' % (s[19:23], s[13:15], s[16:18])
    
    match = re.match( 'Subject:[^0-9]*([0-9]{1,5})', s )
    if match:
        subject = ("0000%s" % match.group(1))[-4:]
    match = re.match( 'Session:[^0-9]*([0-9]{1,5})', s )
    if match:
        session = ("0000%s" % match.group(1))[-4:]

if not subject or not session or not date_of_test:
    sys.exit( "ERROR: no subject, session ID, or test date in Stroop file %s" % args.infile )

# Reconstruct actual N-CANDA Subject ID
digit_to_site = { '1': 'A', '2': 'B', '3': 'C', '4': 'D', '5': 'E', '6': 'F', '7': 'G', '8': 'H', '9': 'I', '0': 'J' }
digit_to_sex = { '1': 'M', '2': 'F', '3': 'X', '4': 'X', '5': 'X', '6': 'X', '7': 'X', '8': 'X', '9': 'T', '0': 'X' }

subject_id = '%s-%s%s-%s-%s' % ( digit_to_site[subject[0]], subject[1:4], session[0:2], digit_to_sex[session[2]], session[3] )

if args.record:
    record_id = args.record
else:
    record_id = '%s-%s' % ( subject_id, date_of_test )

# Open connection to REDCap server
api_key = args.api_key
if not api_key:
    key_file = open( args.api_key_file, 'r' )
    api_key = key_file.read().strip()

project = redcap.Project( 'https://ncanda.sri.com/redcap/api/', api_key, verify_ssl=False)

# Upload given file to REDCap
file = open( args.infile, 'rb')
try:
    response = project.import_file( record=record_id, event=args.event, field=args.tofield, fname=os.path.basename(args.infile), fobj=file )
except redcap.RedcapError:
    # Your import didn't work
    sys.exit( "ERROR: file upload did not work" )
    pass
finally:
    file.close()
